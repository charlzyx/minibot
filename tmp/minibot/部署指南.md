# NanoClaw 容器化部署指南

## 快速开始

### 前置要求
- Docker 20.10+
- Docker Compose 2.0+
- Anthropic API Key
- WhatsApp Business API 账号（可选）

### 安装步骤

1. **克隆仓库**
```bash
git clone https://github.com/qwibitai/nanoclaw.git
cd nanoclaw
```

2. **配置环境变量**
```bash
cp .env.example .env
# 编辑 .env 文件，填入实际的 API 密钥
nano .env
```

3. **使用 Docker Compose 启动**
```bash
docker-compose up -d
```

4. **查看日志**
```bash
docker-compose logs -f nanoclaw
```

## 手动 Docker 部署

### 构建镜像
```bash
docker build -f Dockerfile.nanoclaw -t nanoclaw:latest .
```

### 运行容器
```bash
docker run -d \
  --name nanoclaw \
  --restart unless-stopped \
  -e ANTHROPIC_API_KEY=your_key_here \
  -e WHATSAPP_ACCESS_TOKEN=your_token \
  -v nanoclaw-data:/app/data \
  -v nanoclaw-logs:/app/logs \
  -v nanoclaw-groups:/app/groups \
  nanoclaw:latest
```

## 配置说明

### 环境变量

| 变量名 | 必需 | 说明 |
|--------|------|------|
| `ANTHROPIC_API_KEY` | 是 | Anthropic Claude API 密钥 |
| `WHATSAPP_PHONE_NUMBER_ID` | 否 | WhatsApp Business API 电话号码 ID |
| `WHATSAPP_ACCESS_TOKEN` | 否 | WhatsApp 访问令牌 |
| `WHATSAPP_WEBHOOK_VERIFY_TOKEN` | 否 | Webhook 验证令牌 |
| `WHATSAPP_WEBHOOK_URL` | 否 | Webhook URL |
| `NODE_ENV` | 否 | 运行环境（默认: production） |
| `LOG_LEVEL` | 否 | 日志级别（默认: info） |

### 挂载卷

| 卷路径 | 用途 |
|--------|------|
| `/app/data` | SQLite 数据库和配置数据 |
| `/app/logs` | 日志文件 |
| `/app/groups` | 群组数据和记忆 |
| `/app/container/skills` | Claude Code 技能文件 |

## 管理命令

### 查看容器状态
```bash
docker ps | grep nanoclaw
```

### 查看日志
```bash
docker logs nanoclaw
docker logs -f nanoclaw  # 实时跟踪
```

### 进入容器
```bash
docker exec -it nanoclaw /bin/bash
```

### 重启服务
```bash
docker-compose restart nanoclaw
# 或
docker restart nanoclaw
```

### 停止服务
```bash
docker-compose down
# 或
docker stop nanoclaw
```

### 删除容器（保留数据）
```bash
docker-compose down
docker rm nanoclaw
```

### 完全删除（包括数据）
```bash
docker-compose down -v
docker rm nanoclaw
docker rmi nanoclaw:latest
```

## 数据备份

### 备份数据卷
```bash
docker run --rm -v nanoclaw-data:/data -v $(pwd):/backup \
  ubuntu tar czf /backup/nanoclaw-data-backup-$(date +%Y%m%d).tar.gz /data
```

### 恢复数据
```bash
docker run --rm -v nanoclaw-data:/data -v $(pwd):/backup \
  ubuntu tar xzf /backup/nanoclaw-data-backup-20240114.tar.gz -C /
```

## 故障排查

### 容器无法启动
```bash
# 查看容器日志
docker logs nanoclaw

# 检查容器状态
docker inspect nanoclaw

# 进入容器调试
docker exec -it nanoclaw /bin/bash
```

### API 密钥错误
确保 `.env` 文件中的 `ANTHROPIC_API_KEY` 正确配置。

### 容器资源不足
调整 `docker-compose.yml` 中的资源限制：
```yaml
deploy:
  resources:
    limits:
      cpus: '4.0'      # 增加 CPU 限制
      memory: 4G       # 增加内存限制
```

## 安全建议

1. **保护环境变量**
   - 不要将 `.env` 文件提交到版本控制
   - 使用 Docker Secrets 或环境变量文件（`--env-file`）
   - 定期轮换 API 密钥

2. **网络隔离**
   - 使用私有 Docker 网络
   - 仅暴露必要的端口
   - 配置防火墙规则

3. **容器加固**
   - 以非 root 用户运行容器
   - 使用只读文件系统（如适用）
   - 定期更新基础镜像

## 性能优化

### 资源调整
根据负载调整 `docker-compose.yml` 中的资源配置：
```yaml
deploy:
  resources:
    limits:
      cpus: '2.0'
      memory: 2G
    reservations:
      cpus: '1.0'
      memory: 1G
```

### 日志管理
配置日志轮转以防止磁盘空间不足：
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

## 监控和告警

### 健康检查
容器已配置健康检查，可通过以下命令查看：
```bash
docker inspect --format='{{.State.Health.Status}}' nanoclaw
```

### 日志监控
使用日志聚合工具（如 ELK Stack、Grafana Loki）监控应用日志。

## 升级

### 更新到最新版本
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### 滚动更新（零停机）
```bash
docker-compose up -d --no-deps --build nanoclaw
```

## 支持

如遇问题，请：
1. 查看项目文档：https://github.com/qwibitai/nanoclaw
2. 加入 Discord 社区：https://discord.gg/VGWXrf8x
3. 提交 Issue：https://github.com/qwibitai/nanoclaw/issues
